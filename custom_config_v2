(function() {
    'use strict';

    const CONFIG_LABEL = 'custom_config_v2';
    let config = null;

    function log(level, ...args) {
        if (!config || level === 'error') {
            console[level || 'log'](...args);
            return;
        }
        const levels = ['debug', 'info', 'warn', 'error'];
        if (levels.indexOf(level) >= levels.indexOf(config.LOG_LEVEL)) {
            console[level](...args);
        }
    }

    function decodeHtml(html) {
        const txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    function extractYAMLFromHTML(html) {
        const match = html.match(/<code>([\s\S]*?)<\/code>/);
        return match && match[1] ? decodeHtml(match[1].trim()) : null;
    }

    async function loadYAML() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    function validateYAML(yamlString) {
        try {
            return jsyaml.load(yamlString);
        } catch (e) {
            throw new Error('Invalid YAML: ' + e.message);
        }
    }

    async function getConfigValues() {
        try {
            await loadYAML();

            const elements = document.querySelectorAll('div[data-react-props]');
            log('debug', 'Found elements:', elements.length);

            for (const el of elements) {
                try {
                    const rawProps = el.getAttribute('data-react-props');
                    log('debug', 'Raw data-react-props:', rawProps);

                    const decodedProps = decodeHtml(rawProps);
                    log('debug', 'Decoded data-react-props:', decodedProps);

                    const props = JSON.parse(decodedProps);
                    log('debug', 'Parsed props:', props);

                    if (props.questions) {
                        log('debug', 'Questions found:', props.questions.length);
                        props.questions.forEach((q, i) => {
                            log('debug', `Question ${i}:`, q.label);
                        });
                    } else {
                        log('debug', 'No questions found in props');
                    }

                    const question = props.questions?.find(q => q.label === CONFIG_LABEL);

                    if (question) {
                        log('debug', 'Found question:', question);
                        const configYAML = extractYAMLFromHTML(question.text);
                        if (!configYAML) {
                            log('error', 'No YAML found in config HTML');
                            continue;
                        }

                        log('debug', 'Extracted YAML:', configYAML);
                        config = validateYAML(configYAML);
                        log('info', 'Config loaded:', config);
                        return config;
                    }
                } catch (e) {
                    log('error', 'Error processing element:', el);
                    log('error', 'Error details:', e);
                    log('error', 'Error stack:', e.stack);
                }
            }
            log('warn', 'Configuration element not found');
            return null;
        } catch (error) {
            log('error', 'Failed to load config:', error);
            return null;
        }
    }

    window.configLoader = {
        getConfig: getConfigValues
    };
})();
